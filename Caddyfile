{
    email cherus09@mail.ru
    # Отключаем попытки on-demand, используем обычный ACME
    acme_ca https://acme-v02.api.letsencrypt.org/directory
}

ai-generator.mix4.ru {
    encode gzip

    # VK OAuth support - allow popups for OAuth flow
    header Cross-Origin-Opener-Policy "same-origin-allow-popups"

    # Content Security Policy - разрешения для Google OAuth, VK ID SDK и OAuth
    header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://*.vk.com https://*.vk.ru https://accounts.google.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com; connect-src 'self' https://*.vk.com https://*.vk.ru https://id.vk.com wss://*.vk.com https://accounts.google.com https://*.googleapis.com; frame-src 'self' https://*.vk.com https://*.vk.ru https://id.vk.com https://accounts.google.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; object-src 'none'; base-uri 'self'; form-action 'self';"

    # Security headers
    header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    header X-Content-Type-Options "nosniff"
    header X-Frame-Options "SAMEORIGIN"
    header Referrer-Policy "no-referrer-when-downgrade"

    @api path /api/* /health
    handle @api {
        reverse_proxy backend:8000 {
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    @uploads path /uploads/*
    handle @uploads {
        reverse_proxy backend:8000 {
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    handle {
        reverse_proxy frontend:80 {
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    # Ограничение размера загрузок (до 20 МБ с запасом)
    request_body {
        max_size 20MB
    }
}
