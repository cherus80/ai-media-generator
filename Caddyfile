{
    email ai-generator@mix4.ru
    # Отключаем попытки on-demand, используем обычный ACME
    acme_ca https://acme-v02.api.letsencrypt.org/directory
}

ai-generator.mix4.ru {
    encode gzip

    # Content Security Policy - разрешения для Google OAuth, VK ID SDK, Yandex и Telegram Login Widget
    header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://*.vk.com https://*.vk.ru https://accounts.google.com https://apis.google.com https://telegram.org https://*.telegram.org https://mc.yandex.ru https://mc.webvisor.org; style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com https://accounts.google.com; connect-src 'self' https://*.vk.com https://*.vk.ru https://id.vk.com wss://*.vk.com https://accounts.google.com https://*.googleapis.com https://telegram.org https://*.telegram.org https://mc.yandex.ru https://mc.webvisor.org wss://mc.yandex.ru wss://mc.webvisor.org; frame-src 'self' https://*.vk.com https://*.vk.ru https://id.vk.com https://accounts.google.com https://telegram.org https://*.telegram.org https://oauth.telegram.org; img-src 'self' data: https: blob: https://mc.yandex.ru https://telegram.org https://*.telegram.org; font-src 'self' data: https://fonts.gstatic.com; object-src 'none'; base-uri 'self'; form-action 'self';"

    # Security headers
    header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    header X-Content-Type-Options "nosniff"
    header X-Frame-Options "SAMEORIGIN"
    header Referrer-Policy "no-referrer-when-downgrade"
    header X-Download-Options "noopen"
    header X-Permitted-Cross-Domain-Policies "none"
    header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()"
    header -Server

    @api path /api/* /health
    handle @api {
        reverse_proxy waf:80 {
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    @uploads path /uploads/*
    handle @uploads {
        reverse_proxy waf:80 {
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    handle {
        reverse_proxy waf:80 {
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    # Ограничение размера загрузок (до 100 МБ с запасом)
    request_body {
        max_size 200MB
    }
}

# Принудительный редирект HTTP → HTTPS
http://ai-generator.mix4.ru {
    redir https://ai-generator.mix4.ru{uri} permanent
}
