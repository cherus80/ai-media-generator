–ü–æ–Ω—è–ª ‚Äî —Å—Ä–µ–¥–∞ —Å–Ω–æ–≤–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ Python (—ç—Ç–æ —É–∂–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ: –±–æ–ª—å—à–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–µ—Å—Å–∏—è—Ö –Ω–µ –¥–∞—é—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å).

üëâ **–ü–æ—ç—Ç–æ–º—É —è –∑–∞–≤–µ—Ä–Ω—É –≤–µ—Å—å MD-—Ñ–∞–π–ª –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏**, –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π –∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—é.

–¢—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞—ë—à—å —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é:

**–ù–∞–∑–≤–∞–Ω–∏–µ:**
`billing_actions_credits_v5.md`

–ò –≤—Å—Ç–∞–≤–ª—è–µ—à—å —Ç—É–¥–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∏–∂–µ ‚Üì

---

# üì¶ –ì–û–¢–û–í–´–ô –§–ê–ô–õ `billing_actions_credits_v5.md`

````markdown
# Billing v5 ‚Äî –î–µ–π—Å—Ç–≤–∏—è + –ö—Ä–µ–¥–∏—Ç—ã + Free Trial (–±–µ–∑ freemium)

## 0. –û–±—â–∞—è –∏–¥–µ—è

–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å **–¥–≤–µ —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏**:

1. **–î–µ–π—Å—Ç–≤–∏—è** ‚Äî —ç—Ç–æ –ª–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ **–ø–æ–¥–ø–∏—Å–∫–µ**.  
   - 1 –¥–µ–π—Å—Ç–≤–∏–µ = 1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä–∫–∞ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç).  
2. **–ö—Ä–µ–¥–∏—Ç—ã** ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞, –∫–æ—Ç–æ—Ä–æ–π –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è:
   - –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ **–±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏** –∏–ª–∏ –ø–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –ª–∏–º–∏—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π  
   - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞** (–≤—Å–µ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –∫—Ä–µ–¥–∏—Ç—ã)  
   - –∏ –≤—ã–¥–∞—ë—Ç—Å—è **Free Trial** (10 –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏).

–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–∞—ë—Ç **–¥–µ–π—Å—Ç–≤–∏—è**, –∞ –ø–∞–∫–µ—Ç—ã ‚Äî **–∫—Ä–µ–¥–∏—Ç—ã**. –≠—Ç–æ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–∞.

---

## 1. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ)

### 1.1. User

```ts
User {
  id: string

  // –ü–æ–¥–ø–∏—Å–∫–∞
  plan_id: 'basic' | 'standard' | 'premium' | null
  plan_active: boolean
  plan_started_at: Date | null
  plan_expires_at: Date | null

  plan_actions_limit: number        
  plan_actions_used: number         

  // –ö—Ä–µ–¥–∏—Ç—ã
  credits_balance: number           

  // Free Trial
  free_trial_granted: boolean       

  // –°–ª—É–∂–µ–±–Ω–æ–µ
  is_admin: boolean
}
````

### 1.2. SubscriptionPlan

```ts
SubscriptionPlan {
  id: 'basic' | 'standard' | 'premium'
  price_rub: number
  actions_limit: number
  period_days: number
}
```

### 1.3. CreditPack

```ts
CreditPack {
  id: 'small' | 'medium' | 'large' | 'pro'
  credits: number
  price_rub: number
}
```

### 1.4. Ledger

```ts
CreditsLedger {
  id: string
  user_id: string
  type: 
    | 'tryon_generation'
    | 'edit_generation'
    | 'assistant_call'
    | 'subscription_actions_spent'
    | 'subscription_purchase'
    | 'subscription_renew'
    | 'credit_pack_purchase'
    | 'free_trial_grant'
  amount: number           
  unit: 'credits' | 'actions'
  created_at: Date
  meta: Json
}
```

---

## 2. –¢–∞—Ä–∏—Ñ—ã –∏ —Ü–µ–Ω—ã

### 2.1. –ü–æ–¥–ø–∏—Å–∫–∏

| plan_id  | –¶–µ–Ω–∞ | –õ–∏–º–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π |
| -------- | ---- | -------------- |
| basic    | 299‚ÇΩ | 80             |
| standard | 499‚ÇΩ | 130            |
| premium  | 899‚ÇΩ | 250            |

### 2.2. –ü–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤

| pack_id | –ö—Ä–µ–¥–∏—Ç—ã | –¶–µ–Ω–∞ |
| ------- | ------- | ---- |
| small   | 20      | 100‚ÇΩ |
| medium  | 50      | 230‚ÇΩ |
| large   | 100     | 400‚ÇΩ |
| pro     | 250     | 900‚ÇΩ |

### 2.3. Free Trial

–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:

```
+10 –∫—Ä–µ–¥–∏—Ç–æ–≤ –æ–¥–∏–Ω —Ä–∞–∑
```

---

## 3. –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

```
1 –¥–µ–π—Å—Ç–≤–∏–µ = 1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = 2 –∫—Ä–µ–¥–∏—Ç–∞ (–µ—Å–ª–∏ –Ω–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π)
1 –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É = 1 –∫—Ä–µ–¥–∏—Ç
```

---

## 4. –õ–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏–π (–ø—Å–µ–≤–¥–æ–∫–æ–¥)

### 4.1. Helpers

```ts
function hasActivePlan(user) {
  return user.plan_active && user.plan_expires_at > now()
}

function actionsRemaining(user) {
  if (!hasActivePlan(user)) return 0
  return Math.max(user.plan_actions_limit - user.plan_actions_used, 0)
}
```

---

### 4.2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è (–ø—Ä–∏–º–µ—Ä–∫–∞ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç)

```ts
function chargeGeneration(user, kind) {
  if (user.is_admin) return ok('admin_free')

  if (hasActivePlan(user) && actionsRemaining(user) > 0) {
    user.plan_actions_used += 1
    logAction(...)
    return ok('action')
  }

  if (user.credits_balance >= 2) {
    user.credits_balance -= 2
    logCredits(...)
    return ok('credits')
  }

  return error('NOT_ENOUGH_BALANCE')
}
```

---

### 4.3. AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

```ts
function chargeAssistant(user) {
  if (user.is_admin) return ok('admin_free')

  if (user.credits_balance >= 1) {
    user.credits_balance -= 1
    logAssistant(...)
    return ok('credits')
  }

  return error('NOT_ENOUGH_CREDITS_FOR_ASSISTANT')
}
```

---

## 5. –ù–∞—á–∏—Å–ª–µ–Ω–∏—è

### 5.1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```ts
function onUserRegister(user) {
  if (!user.free_trial_granted) {
    user.credits_balance += 10
    user.free_trial_granted = true
    logFreeTrial(...)
  }
}
```

---

### 5.2. –ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏

```ts
function onSubscriptionPaid(user, plan) {
  user.plan_id = plan.id
  user.plan_active = true
  user.plan_actions_limit = plan.actions_limit
  user.plan_actions_used = 0
  user.plan_started_at = now()
  user.plan_expires_at = now() + plan.period_days

  logSubscription(...)
}
```

---

### 5.3. –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤

```ts
function onCreditPackPaid(user, pack) {
  user.credits_balance += pack.credits
  logCreditPurchase(...)
}
```

---

## 6. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤

### –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ–≥–¥–∞:

```
–ö—Ä–µ–¥–∏—Ç—ã: X
```

### –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ:

```
–î–µ–π—Å—Ç–≤–∏—è: {–æ—Å—Ç–∞–ª–æ—Å—å} / {–≤—Å–µ–≥–æ}
```

–ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç ‚Äî –±–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å–∫—Ä—ã—Ç—å.

---

## 7. UI-—Ç–µ–∫—Å—Ç—ã

### –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø—Ä–∏–º–µ—Ä–∫–∞

```
–°—Ç–æ–∏–º–æ—Å—Ç—å:
‚Äî 1 –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ
‚Äî –∏–ª–∏ 2 –∫—Ä–µ–¥–∏—Ç–∞ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
```

### –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è:
‚Äî 1 –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ 2 –∫—Ä–µ–¥–∏—Ç–∞

AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç:
‚Äî 1 –∫—Ä–µ–¥–∏—Ç
```

---

## 8. –û—à–∏–±–∫–∏

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è

```
NOT_ENOUGH_BALANCE ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫—É–ø–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã –∏–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É
```

### –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç

```
NOT_ENOUGH_CREDITS_FOR_ASSISTANT ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫—É–ø–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã
```

---

## 9. Edge Cases

* –í—Å—ë —Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ Ledger.
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π (mutex / optimistic lock).
* –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π (payment_id –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á).
* –ê–¥–º–∏–Ω—ã ‚Üí –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
* –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:

  * plan_active = false
  * actionsRemaining = 0

---

## 10. –†–µ–∑—é–º–µ

* –î–≤–∞ –±–∞–ª–∞–Ω—Å–∞: **–î–µ–π—Å—Ç–≤–∏—è (–ø–æ–¥–ø–∏—Å–∫–∞)** –∏ **–ö—Ä–µ–¥–∏—Ç—ã (–≤—Å–µ–≥–¥–∞)**.
* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è: 1 –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ 2 –∫—Ä–µ–¥–∏—Ç–∞.
* –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: –≤—Å–µ–≥–¥–∞ 1 –∫—Ä–µ–¥–∏—Ç.
* Free Trial: +10 –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
* –ü–æ–¥–ø–∏—Å–∫–∏: 80 / 130 / 250 –¥–µ–π—Å—Ç–≤–∏–π.
* –ü–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤: 20 / 50 / 100 / 250.
* –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ Ledger.

```
