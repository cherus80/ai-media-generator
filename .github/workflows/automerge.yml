name: Enable PR Auto-Merge

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - labeled
      - ready_for_review

permissions:
  contents: write
  pull-requests: write

jobs:
  enable:
    name: Enable auto-merge
    runs-on: ubuntu-latest
    if: >-
      github.event.pull_request.draft == false &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'automerge') &&
      github.event.pull_request.user.login == 'cherus80'

    steps:
      - name: Enable auto-merge (squash)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            const query = `
              query($owner:String!, $repo:String!, $number:Int!) {
                repository(owner:$owner, name:$repo) {
                  pullRequest(number:$number) { id }
                }
              }
            `;

            const res = await github.graphql(query, { owner, repo, number: prNumber });
            const pullRequestId = res.repository.pullRequest.id;

            const mutation = `
              mutation($pullRequestId:ID!) {
                enablePullRequestAutoMerge(input:{
                  pullRequestId:$pullRequestId,
                  mergeMethod:SQUASH
                }) {
                  pullRequest { number }
                }
              }
            `;

            await github.graphql(mutation, { pullRequestId });
            core.info(`Auto-merge enabled for PR #${prNumber}.`);

