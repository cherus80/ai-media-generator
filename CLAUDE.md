# AI Image Generator Bot – Telegram Web App

## Цель проекта
Создать Telegram Web App для виртуальной примерки одежды/аксессуаров и редактирования изображений с помощью модели Nano Banana через kie.ai и ассистента Claude Haiku (OpenRouter), с гибридной монетизацией (Freemium, подписки, покупка кредитов) и безопасной архитектурой.

## Технологический стек
- Frontend: React 18+ (TypeScript, Vite, Tailwind, Telegram WebApp SDK)
- Backend: FastAPI (Python 3.11+), SQLAlchemy (async), Celery, WebSocket, Pydantic
- База данных: PostgreSQL 15 (JSONB для истории чата)
- Внешние API: kie.ai Nano Banana, OpenRouter (Claude Haiku), ЮKassa, Telegram Bot API
- Деплой: Docker/Portainer (Beget VPS)

## Ключевые функции
1. **Примерка одежды/аксессуаров (step-квиз без AI-ассистента)**
   - Фиксированный промпт для генерации через kie.ai
   - Валидация файлов (JPEG/PNG, ≤5MB, MIME, UUID-имя)
   - Списание 2 кредитов за генерацию

2. **Редактирование изображений (чат с AI-ассистентом)**
   - История чата (только последние 10 сообщений)
   - Генерация нескольких вариантов промптов через Claude Haiku (OpenRouter)
   - WebSocket для отображения прогресса
   - Списание 1 кредит за запрос, 1 — за генерацию

3. **Авторизация**
   - Проверка Telegram initData через HMAC SHA-256
   - JWT-токены для сессий

4. **Монетизация**
   - Freemium: 10 действий/месяц с водяным знаком
   - Подписки: 299₽/50, 499₽/150, 899₽/500 действий
   - Кредиты: 199₽/100 кредитов
   - ЮKassa webhook и автоматическое начисление
   - Учёт налогов для НПД (4%) и комиссии ЮKassa (2.8%)

## Стандарты кодирования
- async/await для всех IO-операций (Backend)
- Проверка файлов MIME-типов и сигнатур (magic bytes)
- Разделение структуры /backend, /frontend с отдельными CLAUDE.md
- Каждый модуль должен иметь отдельный CLAUDE.md с описанием логики
- No sensitive keys in code: все через переменные окружения (.env)
- API-ключи для всех интеграций указывать только в .env

## Структура базы данных
- Таблицы: users, generations, chat_history, payments (описать поля и индексы кратко)
- Чат-история — хранить последние 10 сообщений (JSONB)
- Идемпотентность: использовать idempotency_key при начислении кредитов

## Интеграции
- **kie.ai Nano Banana API**: описание endpoint и параметров
- **OpenRouter Claude Haiku**: системный промпт на английском, структура сообщений для чата
- **ЮKassa**: URL webhook, проверка подписи, поля для идентификации платежа и начисления токенов

## Обработка ошибок
- Retry для API-запросов (3 попытки, exponential backoff)
- Отправка ошибок в чат с понятным сообщением для пользователя

## Важные ограничения
- Не хранить пароли в открытом виде
- Не доверять только расширению файлов — проверять тип и сигнатуру
- Не использовать синхронные операции БД
- Для генерации изображений использовать Celery (не FastAPI BackgroundTasks)
- Отправлять только последние 10 сообщений в OpenRouter для чата

## Обязательно записывай всю историю изминений в проекте в файле CHANGELOG.md
